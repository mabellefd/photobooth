import { useState, useRef, useCallback } from "react";
import { Button } from "@/components/ui/button";
import { motion } from "framer-motion";
import Webcam from "react-webcam";

const filters = ["none", "brightness(1.2)", "sepia(1)", "grayscale(1)", "contrast(0.8)", "saturate(0.8)"];

export default function PhotoBooth() {
  const [step, setStep] = useState(1);
  const [photos, setPhotos] = useState([]);
  const [filter, setFilter] = useState("none");
  const [countdown, setCountdown] = useState(null);
  const webcamRef = useRef(null);

  const capturePhoto = useCallback(() => {
    if (webcamRef.current) {
      const imageSrc = webcamRef.current.getScreenshot();
      setPhotos((prev) => [...prev, imageSrc]);
    }
  }, [webcamRef, setPhotos]);

  const startCapture = async () => {
    setPhotos([]);
    for (let i = 4; i > 0; i--) {
      setCountdown(5);
      await new Promise((resolve) => {
        let timer = 5;
        const interval = setInterval(() => {
          setCountdown((prev) => prev - 1);
          timer--;
          if (timer === 0) {
            clearInterval(interval);
            capturePhoto();
            resolve();
          }
        }, 1000);
      });
    }
    setCountdown(null);
    setStep(4);
  };

  const downloadPhotoStrip = () => {
    const canvas = document.createElement("canvas");
    const ctx = canvas.getContext("2d");
    const width = 400;
    const height = 600;
    canvas.width = width;
    canvas.height = height;
    
    ctx.fillStyle = "white";
    ctx.fillRect(0, 0, width, height);
    photos.forEach((photo, index) => {
      const img = new Image();
      img.src = photo;
      img.onload = () => {
        ctx.drawImage(img, 50, index * 120 + 10, 300, 100);
        if (index === photos.length - 1) {
          ctx.fillStyle = "black";
          ctx.font = "20px Arial";
          ctx.fillText("Ground Zero", 150, 580);
          const finalImage = canvas.toDataURL("image/png");
          const link = document.createElement("a");
          link.href = finalImage;
          link.download = "photobooth.png";
          link.click();
        }
      };
    });
  };

  return (
    <div className="flex flex-col items-center justify-center min-h-screen p-4">
      {step === 1 && (
        <motion.div initial={{ opacity: 0 }} animate={{ opacity: 1 }}>
          <h1 className="text-3xl font-bold">Convenient Photobooth</h1>
          <p>Wherever you are, capture your moments.</p>
          <Button onClick={() => setStep(2)}>Start</Button>
        </motion.div>
      )}

      {step === 2 && (
        <motion.div initial={{ opacity: 0 }} animate={{ opacity: 1 }}>
          <h2 className="text-2xl font-bold">How It Works</h2>
          <p>You'll take 4 photos with a 5-second interval. You can retake once.</p>
          <Button onClick={() => setStep(3)}>Proceed</Button>
        </motion.div>
      )}

      {step === 3 && (
        <motion.div initial={{ opacity: 0 }} animate={{ opacity: 1 }}>
          <Webcam ref={webcamRef} screenshotFormat="image/png" videoConstraints={{ facingMode: "user" }} className="border p-2" style={{ filter }} />
          <div className="flex gap-2 mt-2">
            {filters.map((f, index) => (
              <Button key={index} onClick={() => setFilter(f)}>{f.replace("(1)", "")}</Button>
            ))}
          </div>
          {countdown !== null && <p className="text-xl font-bold">{countdown}</p>}
          <Button onClick={startCapture}>Start Capture</Button>
        </motion.div>
      )}

      {step === 4 && (
        <motion.div initial={{ opacity: 0 }} animate={{ opacity: 1 }}>
          <div className="border-4 border-white p-2">
            {photos.map((photo, index) => (
              <img key={index} src={photo} alt={`Captured ${index}`} className="w-full" />
            ))}
            <p className="text-center font-bold">Ground Zero</p>
          </div>
          <div className="flex gap-2 mt-2">
            <Button onClick={() => setStep(3)}>Retake</Button>
            <Button onClick={downloadPhotoStrip}>Download</Button>
          </div>
        </motion.div>
      )}
    </div>
  );
}

// Netlify Redirects Fix
if (typeof window !== "undefined") {
  if (window.location.pathname !== "/") {
    window.history.replaceState(null, "", "/");
  }
}
